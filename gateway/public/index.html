<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目管理</title> <link rel="shortcut icon" href="/image/favicon.ico" type="image/x-icon">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/pm.css" rel="stylesheet">
    <style>
        /* Add some spacing for the new elements */
        .server-select-container { margin-bottom: 1.5rem; }
        #serverManagementBtn { margin-left: 10px; }
    </style>
</head>
<body>
<div class="container">

    <div class="d-flex justify-content-between align-items-center server-select-container">
        <div>
            <label for="serverSelect" class="form-label">选择服务器:</label>
            <select id="serverSelect" class="form-select d-inline-block w-auto me-2">
                <option value="">-- Loading Servers --</option>
            </select>
            <button id="refreshServersBtn" class="btn btn-sm btn-outline-secondary" title="Refresh Server List">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <button type="button" class="btn btn-outline-info" id="serverManagementBtn" data-bs-toggle="modal" data-bs-target="#serverManagementModal">
            <i class="bi bi-hdd-stack"></i> 管理服务器
        </button>
    </div>


    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <span class="server-name" id="serverName">请选择一个服务器</span>
        </h2>
        <button type="button" class="btn btn-primary" onclick="registerOnline()" id="registerBtn" aria-label="注册在线项目" disabled> <i class="bi bi-plus-circle" aria-hidden="true"></i> 注册在线项目
        </button>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>项目名称</th>
                <th>端口</th>
                <th>PID</th>
                <th>目录</th>
                <th>启动命令</th>
                <th>脚本命令</th>
                <th>项目描述</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="projectList">
            <tr><td colspan="9" class="text-center text-muted py-4">请先选择一个服务器来查看项目。</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="contextMenu" class="context-menu" style="display: none;" role="menu">
    <button type="button" class="context-menu-item" onclick="handleContextMenu('copy')" role="menuitem" tabindex="0">
        复制内容
    </button>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editPid">
                    <input type="hidden" id="editServerName"> <div class="mb-3">
                    <label for="editScript" class="form-label">脚本命令</label>
                    <textarea class="form-control" id="editScript" rows="3" required></textarea>
                </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">项目描述</label>
                        <textarea class="form-control" id="editDescription" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="outputModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">运行输出</h5>
            </div>
            <div class="modal-body">
                <pre id="outputContent" class="output-content"></pre>
                <div class="text-center" id="outputLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">运行中...</span>
                    </div>
                    <p class="mt-2">正在执行，请稍候...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="serverManagementModal" tabindex="-1" aria-labelledby="serverManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serverManagementModalLabel">管理服务器</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5>已注册服务器</h5>
                <ul id="registeredServerList" class="list-group mb-3">
                    <li class="list-group-item">Loading...</li>
                </ul>
                <hr>
                <h5>添加新服务器</h5>
                <form id="addServerForm">
                    <div class="mb-3">
                        <label for="newServerName" class="form-label">服务器名称 (唯一)</label>
                        <input type="text" class="form-control" id="newServerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="newServerUrl" class="form-label">服务器 Base URL (e.g., http://localhost:8080)</label>
                        <input type="url" class="form-control" id="newServerUrl" placeholder="http://example.com:port" required>
                    </div>
                    <button type="submit" class="btn btn-success">添加服务器</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


<script src="/js/bootstrap.bundle.min.js"></script>
<script>
    let contextMenuTarget = null;
    let currentServerName = null; // Track the selected server

    // --- Server Management ---
    const serverSelect = document.getElementById('serverSelect');
    const serverNameDisplay = document.getElementById('serverName');
    const projectListBody = document.getElementById('projectList');
    const registerBtn = document.getElementById('registerBtn');
    const refreshServersBtn = document.getElementById('refreshServersBtn');
    const serverManagementModal = new bootstrap.Modal(document.getElementById('serverManagementModal'));
    const registeredServerList = document.getElementById('registeredServerList');
    const addServerForm = document.getElementById('addServerForm');
    const newServerNameInput = document.getElementById('newServerName');
    const newServerUrlInput = document.getElementById('newServerUrl');

    async function fetchAndPopulateServers(selectTargetServer = null) {
        try {
            refreshServersBtn.disabled = true;
            const response = await fetch('/api/servers'); // Fetch from Node backend
            if (!response.ok) throw new Error(`Failed to fetch servers: ${response.statusText}`);
            const servers = await response.json();

            // Populate dropdown
            serverSelect.innerHTML = '<option value="">-- 选择服务器 --</option>'; // Reset
            servers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.name;
                option.textContent = server.name; // Show only name in dropdown
                option.dataset.baseUrl = server.baseUrl; // Store base URL if needed, maybe not
                serverSelect.appendChild(option);
            });

            // Populate management modal list
            registeredServerList.innerHTML = ''; // Clear list
            if (servers.length === 0) {
                registeredServerList.innerHTML = '<li class="list-group-item text-muted">No servers registered yet.</li>';
            } else {
                servers.forEach(server => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                         <span>${server.name} <small class="text-muted">(${server.baseUrl})</small></span>
                         <button class="btn btn-sm btn-outline-danger" onclick="deleteServer('${server.name}')">
                             <i class="bi bi-trash"></i>
                         </button>
                     `;
                    registeredServerList.appendChild(li);
                });
            }


            // Auto-select if needed
            if (selectTargetServer && servers.some(s => s.name === selectTargetServer)) {
                serverSelect.value = selectTargetServer;
                currentServerName = selectTargetServer;
                await fetchProjects(); // Fetch projects for the newly added/selected server
            } else if (servers.length > 0 && !currentServerName) {
                // Select the first server if none is selected
                // serverSelect.value = servers[0].name;
                // currentServerName = servers[0].name;
                // await fetchProjects();
                serverNameDisplay.textContent = "请选择一个服务器";
                document.title = "项目管理";
                projectListBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">请先选择一个服务器来查看项目。</td></tr>';
                registerBtn.disabled = true;

            } else if (currentServerName && !servers.some(s => s.name === currentServerName)) {
                // Current server was deleted, reset state
                currentServerName = null;
                serverNameDisplay.textContent = "请选择一个服务器";
                document.title = "项目管理";
                projectListBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">服务器已移除或未选择。</td></tr>';
                registerBtn.disabled = true;
            }


        } catch (error) {
            console.error("Error fetching servers:", error);
            serverSelect.innerHTML = '<option value="">-- Error Loading --</option>';
            registeredServerList.innerHTML = `<li class="list-group-item text-danger">Error loading server list: ${error.message}</li>`;
            alert('获取服务器列表失败: ' + error.message);
        } finally {
            refreshServersBtn.disabled = false;
        }
    }

    serverSelect.addEventListener('change', async (e) => {
        currentServerName = e.target.value;
        if (currentServerName) {
            registerBtn.disabled = false; // Enable register button
            await fetchProjects(); // Fetch projects for the selected server
        } else {
            serverNameDisplay.textContent = "请选择一个服务器";
            document.title = "项目管理";
            projectListBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">请选择一个服务器来查看项目。</td></tr>';
            registerBtn.disabled = true; // Disable register button if no server selected
        }
    });

    refreshServersBtn.addEventListener('click', () => fetchAndPopulateServers(currentServerName)); // Refresh and try re-selecting current

    addServerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = newServerNameInput.value.trim();
        const baseUrl = newServerUrlInput.value.trim();

        if (!name || !baseUrl) {
            alert("请填写服务器名称和 URL");
            return;
        }

        try {
            const response = await fetch('/api/servers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, baseUrl })
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || `Server responded with ${response.status}`);
            }

            alert(result.message || "服务器添加成功！");
            addServerForm.reset(); // Clear form
            await fetchAndPopulateServers(name); // Refresh list and select the new server
            // serverManagementModal.hide(); // Optionally close modal on success

        } catch (error) {
            console.error("Error adding server:", error);
            alert(`添加服务器失败: ${error.message}`);
        }
    });

    async function deleteServer(serverName) {
        if (!confirm(`确定要移除服务器 "${serverName}" 吗？`)) {
            return;
        }
        try {
            // Encode the server name for the URL
            const encodedServerName = encodeURIComponent(serverName);
            const response = await fetch(`/api/servers/${encodedServerName}`, {
                method: 'DELETE'
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || `Server responded with ${response.status}`);
            }

            alert(result.message || `服务器 "${serverName}" 已移除`);
            await fetchAndPopulateServers(currentServerName); // Refresh server list, keep current selection if possible

        } catch (error) {
            console.error(`Error deleting server ${serverName}:`, error);
            alert(`移除服务器失败: ${error.message}`);
        }
    }


    // --- Original Project Functions (Modified for Server Selection) ---

    async function registerOnline() {
        if (!currentServerName) {
            alert("请先选择一个服务器！");
            return;
        }
        const btn = event.currentTarget;
        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 注册中...';

            // Point to Node.js backend API
            const response = await fetch(`/api/register/${encodeURIComponent(currentServerName)}`, {
                method: 'GET', // Keep original method if backend proxies GET
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (!response.ok) {
                // Use error message from backend proxy if available
                throw new Error(result.error || result.details || '注册失败');
            }

            // Display message from the *target* server (passed through backend)
            alert(result.data?.message || result.message || '操作完成，但未收到明确消息。');
            await fetchProjects(); // Refresh project list for current server
        } catch (error) {
            alert(`注册失败 (${currentServerName}): ${error.message}`);
        } finally {
            // Re-enable only if a server is still selected
            btn.disabled = !currentServerName;
            btn.innerHTML = '<i class="bi bi-plus-circle" aria-hidden="true"></i> 注册在线项目';
        }
    }

    async function fetchProjects() {
        if (!currentServerName) {
            projectListBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">请先选择一个服务器来查看项目。</td></tr>';
            updatePageTitle(null); // Reset title
            return;
        }

        try {
            // Point to Node.js backend API, encoding server name for URL safety
            const encodedServerName = encodeURIComponent(currentServerName);
            const response = await fetch(`/api/projects/${encodedServerName}`);
            if (!response.ok) {
                const errorResult = await response.json().catch(() => ({})); // Try to get JSON error
                throw new Error(errorResult.error || `服务器 ${currentServerName} 响应 ${response.status}`);
            }
            const data = await response.json(); // Data now comes from Node backend

            projectListBody.innerHTML = ''; // Clear previous list

            // Update page title using the selected server name
            updatePageTitle(currentServerName);

            // Check structure returned by Node proxy
            const projects = data?.data?.list;

            if (!projects || projects.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="9" class="text-center text-muted py-4">
                        <div>
                            <i class="bi bi-inbox fs-4"></i>
                            <p class="mt-2">服务器 ${currentServerName} 上暂无项目数据</p>
                        </div>
                    </td>
                `;
                projectListBody.appendChild(tr);
                return;
            }

            projects.forEach(project => {
                const tr = document.createElement('tr');
                // Escape potentially unsafe data before inserting into HTML
                const safeName = escapeHtml(project.name || '');
                const safeCatalog = escapeHtml(project.catalog || '');
                const safeRun = escapeHtml(project.run || '');
                const safeScript = escapeHtml(project.script || '无');
                const safeDescription = escapeHtml(project.description || '无');

                // Add server name data attribute for actions
                tr.dataset.serverName = currentServerName;
                tr.dataset.pid = project.pid;
                tr.dataset.id = project.id; // Needed for delete

                tr.innerHTML = `
                     <td>
                         <div class="code-block truncate" data-bs-toggle="tooltip" title="${safeName}">${safeName}</div>
                     </td>
                     <td>${escapeHtml(project.ports || '')}</td>
                     <td>${escapeHtml(project.pid || '')}</td>
                     <td>
                         <div class="code-block truncate" data-bs-toggle="tooltip" title="${safeCatalog}">${safeCatalog}</div>
                     </td>
                     <td>
                         <div class="code-block truncate" data-bs-toggle="tooltip" title="${safeRun}">${safeRun}</div>
                     </td>
                     <td>
                         <div class="code-block truncate" data-bs-toggle="tooltip" title="${safeScript}">${safeScript}</div>
                     </td>
                     <td>
                         <div class="truncate" data-bs-toggle="tooltip" title="${safeDescription}">${safeDescription}</div>
                     </td>
                     <td>
                         <span class="badge ${project.status === 1 ? 'bg-success' : 'bg-danger'}">
                             ${project.status === 1 ? '运行中' : '已停止'}
                         </span>
                     </td>
                    <td>
                        <div class="btn-group" style="position: relative;">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown"
                                    data-bs-auto-close="outside"
                                    aria-expanded="false">
                                操作
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                ${project.status === 0 ? `
                                    <li><button class="dropdown-item" onclick="startWithRun(${project.pid}, false)">
                                        <i class="bi bi-play-fill text-primary"></i> 原生启动
                                    </button></li>
                                    <li><button class="dropdown-item" onclick="startWithRun(${project.pid}, true)">
                                        <i class="bi bi-play-fill text-success"></i> 原生启动(后台)
                                    </button></li>
                                    <li><button class="dropdown-item" onclick="startWithScript(${project.pid})">
                                        <i class="bi bi-play-circle-fill text-success"></i> 脚本启动
                                    </button></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><button class="dropdown-item text-danger" onclick="deleteProject(${project.id}, ${project.pid})">
                                        <i class="bi bi-trash"></i> 删除
                                    </button></li>
                                ` : `
                                    <li><button class="dropdown-item" onclick="stopProject(${project.pid})">
                                        <i class="bi bi-stop-fill text-danger"></i> 停止
                                    </button></li>
                                `}
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" onclick="showEdit(${project.pid}, '${escapeHtml(project.script || '')}', '${escapeHtml(project.description || '')}')">
                                    <i class="bi bi-pencil text-info"></i> 编辑
                                </button></li>
                            </ul>
                        </div>
                    </td>
                 `;
                projectListBody.appendChild(tr);
            });

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                // Dispose existing tooltip before creating new one
                var existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if (existingTooltip) {
                    existingTooltip.dispose();
                }
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        } catch (error) {
            console.error(`获取项目列表失败 (${currentServerName}):`, error);
            projectListBody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-4">获取项目列表失败: ${error.message}</td></tr>`;
            updatePageTitle(currentServerName, true); // Update title indicating error
        }
    }


    document.addEventListener('contextmenu', function(e) {
        // Allow context menu on regular text, disable for code-blocks only
        if (e.target.classList.contains('code-block')) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            contextMenuTarget = e.target; // The element that was right-clicked

            // Get the *full* text from the title attribute if available (for truncated content)
            const fullText = contextMenuTarget.getAttribute('data-bs-original-title') || contextMenuTarget.textContent;
            contextMenuTarget.dataset.fullText = fullText; // Store it temporarily


            // Set menu position
            const x = e.pageX;
            const y = e.pageY;
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            menu.style.left = (x + menuWidth > windowWidth ? x - menuWidth : x) + 'px';
            menu.style.top = (y + menuHeight > windowHeight ? y - menuHeight : y) + 'px';
            menu.style.display = 'block';

            const firstItem = menu.querySelector('.context-menu-item');
            if (firstItem) {
                firstItem.focus();
            }
        } else {
            // Hide custom menu if right-clicking elsewhere
            hideContextMenu();
        }
    });

    // Hide context menu on click outside or Escape key
    document.addEventListener('click', hideContextMenu);
    document.addEventListener('keydown', function(e) {
        const menu = document.getElementById('contextMenu');
        if (menu.style.display === 'block') {
            if (e.key === 'Escape') {
                hideContextMenu();
            } else if (e.key === 'Enter' && document.activeElement.classList.contains('context-menu-item')) {
                // Trigger action if Enter is pressed on a menu item
                document.activeElement.click();
            }
        }
    });

    function hideContextMenu() {
        const menu = document.getElementById('contextMenu');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
            if (contextMenuTarget) {
                delete contextMenuTarget.dataset.fullText; // Clean up stored text
                contextMenuTarget = null;
            }
        }
    }


    function handleContextMenu(action) {
        if (action === 'copy' && contextMenuTarget) {
            const textToCopy = contextMenuTarget.dataset.fullText || contextMenuTarget.textContent;
            copyText(textToCopy);
        }
        hideContextMenu(); // Hide menu after action
    }


    async function copyText(text) {
        try {
            await navigator.clipboard.writeText(text.trim());
            // Consider a less intrusive notification (e.g., small temporary message)
            // alert('复制成功！');
            console.log('Copied to clipboard:', text.trim());
        } catch (err) {
            console.error('Clipboard copy failed:', err);
            // Fallback (less reliable)
            const textArea = document.createElement('textarea');
            textArea.value = text.trim();
            textArea.style.position = 'fixed'; // Prevent scrolling issues
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                console.log('Copied using fallback.');
            } catch (fallbackErr) {
                alert('复制失败，浏览器不支持或权限不足。请手动复制。');
                console.error('Fallback copy failed:', fallbackErr);
            }
            document.body.removeChild(textArea);
        }
    }

    // Generic request handler (for simple POST/DELETE without output streaming)
    async function handleRequest(url, method = 'POST', body = null) {
        if (!currentServerName) return alert("No server selected!");

        try {
            // Construct URL with encoded server name
            const fullUrl = `/api${url.replace('/jpid/', `/${encodeURIComponent(currentServerName)}/`)}`;
            console.log(`Handling request: ${method} ${fullUrl}`);

            const options = {
                method,
                headers: {}
            };
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }

            const response = await fetch(fullUrl, options);
            const result = await response.json(); // Assume JSON response

            if (!response.ok) {
                throw new Error(result.error || result.message || `Request failed with status ${response.status}`);
            }

            alert(result.message || '操作成功！'); // Display message from backend/target
            // Refresh project list only if the action likely changed state (stop, delete)
            if (method === 'POST' || method === 'DELETE') {
                await fetchProjects();
            }
        } catch (error) {
            console.error(`Operation failed (${method} ${url}):`, error);
            alert(`操作失败: ${error.message}`);
        }
    }

    // Request handler for actions that stream output (SSE)
    async function handleRunRequest(url, method = 'GET', title = "运行输出") {
        if (!currentServerName) return alert("No server selected!");

        // Construct URL for Node.js SSE proxy endpoint
        const encodedServerName = encodeURIComponent(currentServerName);
        // Example original url: /jpid/start/run/123?background=true
        // Needs to become:    /api/start/SERVER_NAME/run/123?background=true
        const apiUrl = url.replace('/jpid/', `/api/start/${encodedServerName}/`);
        console.log(`Handling run request: ${method} ${apiUrl}`);


        // Show output modal
        const outputModalElement = document.getElementById('outputModal');
        const outputModal = bootstrap.Modal.getOrCreateInstance(outputModalElement, {
            backdrop: 'static', // Keep static backdrop
            keyboard: false // Keep keyboard false initially
        });

        // Set title and clear previous state
        outputModalElement.querySelector('.modal-title').textContent = `${title} (${currentServerName})`;
        const outputContent = document.getElementById('outputContent');
        const outputLoading = document.getElementById('outputLoading');
        const modalContent = outputModalElement.querySelector('.modal-content');
        const existingFooter = modalContent.querySelector('.modal-footer');
        if (existingFooter) {
            existingFooter.remove(); // Remove any previous footer/buttons
        }

        outputContent.innerHTML = ''; // Clear previous output
        outputLoading.style.display = 'block'; // Show loading spinner
        outputModal.show();


        // Determine if it's a direct run (not background) to add stop button
        const isDirectRun = url.includes('/start/run') && !url.includes('background=true');
        let currentPidForStopButton = null; // Track PID for the stop button if needed

        try {
            // Connect to the Node.js backend's SSE endpoint
            const eventSource = new EventSource(apiUrl); // URL already includes server name and params

            // --- Event Listeners for SSE ---

            eventSource.addEventListener('output', (e) => {
                outputLoading.style.display = 'none'; // Hide loading once output starts
                const line = e.data;
                // Basic ANSI color handling (add more codes as needed)
                if (line.includes('\x1b[')) {
                    const coloredLine = line
                        .replace(/\x1b\[1;(\d+)m/g, (match, colorCode) => {
                            // Simple mapping (extend as needed)
                            const colors = { '31': '#ff5555', '32': '#50fa7b', '33': '#f1fa8c', '34': '#bd93f9', '36':'#8be9fd' };
                            return `<span style="color: ${colors[colorCode] || 'inherit'}; font-weight: bold;">`;
                        })
                        .replace(/\x1b\[0m/g, '</span>');
                    outputContent.insertAdjacentHTML('beforeend', coloredLine + '\n');
                } else {
                    outputContent.insertAdjacentHTML('beforeend', escapeHtml(line) + '\n');
                }

                // Check for PID message specifically if it's a direct run
                if (isDirectRun) {
                    const pidMatch = line.match(/==> 获取到Java进程 PID: (\d+)/);
                    if (pidMatch && !currentPidForStopButton) { // Only add button once
                        currentPidForStopButton = parseInt(pidMatch[1]);
                        console.log(`Detected PID ${currentPidForStopButton} for direct run, adding stop button.`);
                        addRunningCloseButton(outputModalElement, currentPidForStopButton);
                    }
                }

                // Auto-scroll
                outputContent.scrollTop = outputContent.scrollHeight;
            });

            eventSource.addEventListener('complete', (e) => {
                console.log('SSE stream complete event received.');
                eventSource.close();
                outputLoading.style.display = 'none';
                outputContent.insertAdjacentHTML('beforeend', `<span class="text-success fw-bold">--- 执行完成 (${e.data || 'No message'}) ---</span>\n`);
                outputContent.scrollTop = outputContent.scrollHeight;

                // Add a simple close button if it wasn't a direct run, or if PID wasn't found for direct run
                if (!isDirectRun || !currentPidForStopButton) {
                    addCloseButton(outputModalElement);
                }
                fetchProjects(); // Refresh list after completion
            });

            // Handle errors from the SSE stream itself (e.g., connection closed by backend)
            eventSource.onerror = (e) => {
                console.error('SSE connection error:', e);
                eventSource.close();
                outputLoading.style.display = 'none';

                let errorMsg = '连接已断开或发生错误。';
                // Attempt to parse error data if backend sends JSON in error event
                try {
                    if (e.data) {
                        const errorData = JSON.parse(e.data);
                        errorMsg = errorData.message || errorMsg;
                        if(errorData.details) errorMsg += ` (${errorData.details})`;
                    }
                } catch (parseError) { /* Ignore if data is not JSON */ }


                outputContent.insertAdjacentHTML('beforeend', `<span class="text-danger fw-bold">错误: ${escapeHtml(errorMsg)}</span>\n`);
                outputContent.scrollTop = outputContent.scrollHeight;

                // Add appropriate close button based on context
                if (isDirectRun && currentPidForStopButton) {
                    // Keep the stop button even on error, maybe process is still running?
                    // Or switch to simple close? Let's keep Stop for now.
                    if (!modalContent.querySelector('.modal-footer')) {
                        addRunningCloseButton(outputModalElement, currentPidForStopButton);
                    }
                } else {
                    addCloseButton(outputModalElement); // Add simple close if no stop button exists
                }
                fetchProjects(); // Refresh list even on error
            };

        } catch (error) {
            // This catch handles errors *establishing* the EventSource connection
            console.error(`Failed to establish SSE connection to ${apiUrl}:`, error);
            outputLoading.style.display = 'none';
            outputContent.insertAdjacentHTML('beforeend', `<span class="text-danger fw-bold">错误：无法连接到服务器进行输出流。 ${error.message}</span>\n`);
            addCloseButton(outputModalElement); // Add simple close on connection failure
        }
    }


    function stopProject(pid) {
        if (!currentServerName) return alert("No server selected!");
        handleRequest(`/jpid/stop/${pid}`, 'POST'); // Use POST as per original backend
    }

    function startWithRun(pid, background = false) {
        if (!currentServerName) return alert("No server selected!");
        const title = background ? "原生启动(后台运行)" : "原生启动";
        handleRunRequest(`/jpid/start/run/${pid}?background=${background}`, 'GET', title);
    }

    function startWithScript(pid) {
        if (!currentServerName) return alert("No server selected!");
        handleRunRequest(`/jpid/start/script/${pid}`, 'GET', "脚本启动");
    }

    function showEdit(pid, script, description) {
        if (!currentServerName) return alert("No server selected!");
        document.getElementById('editPid').value = pid;
        document.getElementById('editServerName').value = currentServerName; // Store server context
        document.getElementById('editScript').value = script; // No need to decode HTML entities here if stored correctly
        document.getElementById('editDescription').value = description;
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    async function saveEdit() {
        const pid = document.getElementById('editPid').value;
        const serverName = document.getElementById('editServerName').value; // Get server context
        const script = document.getElementById('editScript').value;
        const description = document.getElementById('editDescription').value;

        if (!serverName) {
            alert('错误：未找到服务器上下文。');
            return;
        }
        // Basic validation
        // if (!script.trim() || !description.trim()) {
        //     alert('请填写脚本和描述信息');
        //     return;
        // }

        // Use the generic handler
        await handleRequest(`/jpid/update/${pid}`, 'POST', { script, description });

        // Hide modal on success (handleRequest already refreshes list)
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('editModal'));
        if (modalInstance) {
            modalInstance.hide();
        }
    }

    async function deleteProject(id, pid) { // Added pid for confirmation message
        if (!currentServerName) return alert("No server selected!");
        if (!confirm(`确定要删除项目 ID ${id} (PID: ${pid}) 吗？此操作不可恢复。`)) {
            return;
        }
        await handleRequest(`/jpid/delete/${id}`, 'DELETE');
    }


    // Add HTML entity escaping function
    function escapeHtml(str) {
        if (typeof str !== 'string') return str; // Handle non-strings
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // --- Modal Footer Helper Functions ---

    // Adds a simple "Close" button to a modal
    function addCloseButton(modalElement) {
        const modalContent = modalElement.querySelector('.modal-content');
        // Avoid adding multiple footers/buttons
        if (modalContent.querySelector('.modal-footer')) return;

        const modalFooter = document.createElement('div');
        modalFooter.className = 'modal-footer';
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        `;
        modalContent.appendChild(modalFooter);
        modalElement.querySelector('#outputLoading').style.display = 'none'; // Ensure loading is hidden
    }

    // Adds a "Stop & Close" button for direct-run processes
    function addRunningCloseButton(modalElement, pid) {
        const modalContent = modalElement.querySelector('.modal-content');
        // Avoid adding multiple footers/buttons
        if (modalContent.querySelector('.modal-footer')) return;

        const modalFooter = document.createElement('div');
        modalFooter.className = 'modal-footer';
        // Pass currentServerName to stopAndClose function
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-danger" onclick="stopAndClose('${currentServerName}', ${pid})">
                <i class="bi bi-stop-circle"></i> 停止并关闭
            </button>
        `;
        modalContent.appendChild(modalFooter);
        modalElement.querySelector('#outputLoading').style.display = 'none'; // Ensure loading is hidden
    }

    // Modified stopAndClose to accept serverName
    async function stopAndClose(serverName, pid) {
        if (!serverName) {
            alert("错误：无法确定目标服务器。");
            return;
        }
        if (confirm(`确定要停止服务器 "${serverName}" 上的进程 PID ${pid} 吗？`)) {
            try {
                const encodedServerName = encodeURIComponent(serverName);
                // Send stop request via backend proxy
                const response = await fetch(`/api/stop/${encodedServerName}/${pid}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json(); // Get result from proxy

                if (!response.ok) {
                    throw new Error(result.error || `停止请求失败: ${response.status}`);
                }

                // Wait a moment *after* confirmation before closing modal
                await new Promise(resolve => setTimeout(resolve, 300));

                // Close modal
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('outputModal'));
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Refresh project list for the *correct* server
                if (currentServerName === serverName) {
                    await fetchProjects();
                } else {
                    console.warn("Stopped process on a server different from the currently viewed one.");
                    // Optionally, you could switch view or just log
                }

            } catch (error) {
                alert(`停止进程 ${pid} 失败: ${error.message}`);
                // Keep the modal open on failure? Or close it? User decision.
                // Maybe change button to simple close?
                const modalElement = document.getElementById('outputModal');
                const footer = modalElement.querySelector('.modal-footer');
                if (footer) {
                    footer.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭 (停止失败)</button>`;
                }
            }
        }
    }


    // --- Page Title Update ---
    function updatePageTitle(serverName, isError = false) {
        const baseTitle = "项目管理";
        if (serverName) {
            const status = isError ? " - Error" : "";
            const title = `${serverName}${status} - ${baseTitle}`;
            serverNameDisplay.textContent = `${serverName}${status}`;
            document.title = title;
        } else {
            serverNameDisplay.textContent = "请选择一个服务器";
            document.title = baseTitle;
        }
    }

    // --- Initial Load ---
    window.onload = () => {
        fetchAndPopulateServers(); // Load server list first
        // fetchProjects will be called when a server is selected
    };

</script>
</body>
</html>
